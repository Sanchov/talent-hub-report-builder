<form [formGroup]="reportForm">
  <div class="report-builder-container">
    <div class="report-content">
      <div
        *ngFor="let sectionCtrl of sections.controls; let i = index"
        [formGroup]="sectionCtrl | controlToFormGroup"
        class="section"
        (drop)="onDrop($event, i)"
        (dragover)="allowDrop($event)"
      >
        <div class="section-header">
          <h3 class="section-title">
            Section {{ (sectionCtrl | controlToFormGroup).get("order")?.value }}
          </h3>
          <button mat-icon-button (click)="openSectionOptions(i)">
            <mat-icon>settings</mat-icon>
          </button>
        </div>

        <div
          cdkDropList
          [cdkDropListData]="
            getComponents(i).controls | controlArrayToFormGroups
          "
          (cdkDropListDropped)="dropComponent($event, i)"
          class="components-list"
        >
          <div
            class="component"
            *ngFor="let component of getComponents(i).controls; let j = index"
            [formGroup]="component | controlToFormGroup"
            cdkDrag
          >
            <mat-card class="component-card">
              <div class="component-header">
                <strong>{{ component.get("type")?.value }}</strong>
                <div class="component-actions">
                  <button mat-button (click)="openOptionsDialog(i, j)">
                    Options
                  </button>
                  <button mat-button (click)="openDataDialog(i, j)">
                    Edit Data
                  </button>
                  <button
                    mat-button
                    color="warn"
                    (click)="removeComponent(i, j)"
                  >
                    Delete
                  </button>
                </div>
              </div>

              <!-- Component Preview -->
              <div class="component-preview">
                <ng-container [ngSwitch]="component.get('type')?.value">
                  <!-- Card Component -->
                  <div *ngSwitchCase="'CARD'" class="preview-card">
                    <h4>
                      {{ component.get("data.header")?.value || "Card Header" }}
                    </h4>
                    <p>
                      {{
                        component.get("data.definition")?.value ||
                          "Card content"
                      }}
                    </p>
                  </div>

                  <!-- Indicator Component -->
                  <div *ngSwitchCase="'INDICATOR'" class="preview-indicator">
                    <div class="indicator-value">
                      {{ component.get("data.dataset.0.value")?.value || "0" }}%
                    </div>
                    <div class="indicator-label">
                      {{
                        component.get("data.dataset.0.name")?.value ||
                          "Indicator"
                      }}
                    </div>
                  </div>

                  <!-- Default Preview -->
                  <div *ngSwitchDefault class="preview-default">
                    {{ component.get("type")?.value }} Component
                  </div>
                </ng-container>
              </div>
            </mat-card>
          </div>
        </div>
      </div>

      <button mat-raised-button color="accent" (click)="addSection()">
        + Add Section
      </button>
    </div>

    <app-sidebar class="sidebar"></app-sidebar>
  </div>
</form>
<div class="competency-button">
  <button mat-raised-button color="primary" (click)="openCompetencyDialog()">
    Manage Competencies
  </button>
</div>

<div class="log-report-button">
  <button mat-raised-button color="primary" (click)="logReport()">
    Log Report
  </button>
</div>

<app-json-parser (jsonParsed)="onJsonParsed($event)"></app-json-parser>
